@model IEnumerable<Capstone2.Models.Menu>

@{
    ViewData["Title"] = "Food Menu";
    var desiredOrder = new[] {
        "MAINDISH",
        "SIDEDISH",
        "DESSERTS",
        "SOFTDRINKS",
        "RICE"
    };

    // 2) group by DishType, then order by position in desiredOrder,
    //    then inside each group still group by Category
    var groupedByDishType =
        Model
         .GroupBy(m => m.DishType)
         .OrderBy(g => Array.IndexOf(desiredOrder, g.Key))
         .Select(dt => new
         {
             DishType = dt.Key,
             CategoryGroups = dt
                                .GroupBy(m => m.Category)
                                .ToList()
         })
         .ToList();

    var orderItemsJson = ViewBag.OrderItemsJson as string;
}

<h1>Food Menu</h1>

<div style="gap: 30px;">
    <!-- Left Column: Food Menu -->
    <div style="flex: 2;">
        @foreach (var dish in groupedByDishType)
        {
            <hr />
            <h2 style="text-transform: uppercase; text-align: center;">
                 @(
                  // Nicely format the header text:
                  dish.DishType switch
                  {
                      "MAINDISH" => "Main Dish",
                      "SIDEDISH" => "Side Dish",
                      "DESSERTS" => "Desserts",
                      "SOFTDRINKS" => "Soft Drinks",
                      "RICE" => "Rice",
                      _ => dish.DishType
                  }
                  )
            </h2>

            @foreach (var cat in dish.CategoryGroups)
            {
                <h3>@cat.Key</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                    @foreach (var item in cat)
                    {
                        <div style="border:1px solid #ccc;border-radius:8px;padding:10px;width:200px;text-align:center;">
                            <b>@item.Name</b>
                            <div style="margin:10px 0;">
                                @if (!string.IsNullOrEmpty(item.ImagePath))
                                {
                                    <img src="@item.ImagePath"
                                         alt="@item.Name"
                                         style="width:150px;height:150px;object-fit:cover;border-radius:6px" />
                                }
                                else
                                {
                                    <span>No image</span>
                                }
                            </div>
                            <div><strong>@($"P{item.Price:0.00}")</strong></div>
                            <div class="input-group quantity-selector" style="max-width:140px;margin-top:10px; right: -20px;">
                                <button class="btn btn-outline-secondary decrement-item"
                                        data-target="#food@(item.MenuId)"
                                        type="button">
                                    −
                                </button>
                                <input type="number"
                                       class="form-control text-center food-no"
                                       id="food@(item.MenuId)"
                                       value="0"
                                       min="1" />
                                <button class="btn btn-outline-secondary increment-item"
                                        data-target="#food@(item.MenuId)"
                                        type="button">
                                    +
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>

    <!-- Floating Order Button and Summary -->
    <div style="position: fixed; bottom: 30px; right: 1px; width: 500px; z-index: 1050;">

        <!-- Order Summary Panel (initially hidden above the button) -->
        <div id="orderSummary" class="border rounded p-3 bg-light shadow mb-2"
             style="display: none; position: absolute; bottom: 50px; right: 0; width: 100%;">
            <h4>Your Order</h4>
            <ul id="orderList" class="list-unstyled">
                <li>No items ordered yet.</li>
            </ul>
            <div id="orderTotal" class="fw-bold mt-2"></div>
            <form id="submitOrderForm" method="post" action="/SelectedFoods/Index">
                <input type="hidden" name="OrderItemsJson" id="OrderItemsJson" />
                <input type="hidden" name="Order.TotalPayment" id="TotalPayment" />
                <button type="submit" class="btn btn-success mt-3 w-100">Next</button>
            </form>

        </div>

        <!-- Button always fixed at bottom -->
        <div class="text-end">
            <button id="toggleOrder" class="btn btn-outline-primary w-100">Show Order Summary</button>
        </div>
    </div>
</</div>

<script>
    let order = {};

    $(function () {
    // Merge previous order if present
    @if (!string.IsNullOrEmpty(orderItemsJson))
    {
        <text>
                try {
                    let prevOrder = JSON.parse('@Html.Raw(orderItemsJson)');
                    prevOrder.forEach(item => {
                    // Always use the latest price from the menu card
                    let $input = $("#food" + item.MenuId);
                let $card = $input.closest(".quantity-selector").parent();
                let name = $card.find("b").text().trim();
                let priceText = $card.find("strong").filter(function () {
                            return $(this).text().startsWith('P');
                        }).first().text().replace("P", "").trim();
                let price = parseFloat(priceText);
                if (!isNaN(price)) {
                    order[item.MenuId] = {
                        MenuId: item.MenuId,
                        name: name || item.Name,
                        price: price,
                        quantity: item.Quantity
                    };
                            setTimeout(() => {
                    let $input = $("#food" + item.MenuId);
                if ($input.length) $input.val(item.Quantity);
                            }, 0);
                        }
                    });
                } catch (e) { }
                    refreshOrderList();
        </text>
    }
    
        $(".increment-item").click(function () {
            let inputSelector = $(this).data('target');
            let $input = $(inputSelector);
            $input.val(parseInt($input.val()) + 1);
            updateOrder($input);
        });

        $(".decrement-item").click(function () {
            let inputSelector = $(this).data('target');
            let $input = $(inputSelector);
            let newValue = parseInt($input.val()) - 1;
            $input.val(newValue < 0 ? 0 : newValue);
            updateOrder($input);
        });

        $(".food-no").on('change', function () {
            $(this).val($(this).val() < 0 ? 0 : $(this).val());
            updateOrder($(this));
        });

        function updateOrder($input) {
            const MenuId = $input.attr("id").replace("food", ""); // Get MenuId
            const $card = $input.closest(".quantity-selector").parent(); // go to outer card

            const name = $card.find("b").text().trim();
            const priceText = $card.find("strong").filter(function () {
                return $(this).text().startsWith('P');
            }).first().text().replace("P", "").trim();

            const price = parseFloat(priceText);
            const quantity = parseInt($input.val());
            
            console.log(name);

            if (!isNaN(price) && quantity > 0) {
                order[MenuId] = { MenuId,  name, price, quantity };
            } else {
                delete order[MenuId];
            }

            refreshOrderList();
        }

        function refreshOrderList() {
            const $orderList = $("#orderList");
            const $orderTotal = $("#orderTotal");
            $orderList.empty();

            const keys = Object.keys(order);
            if (keys.length === 0) {
                $orderList.append("<li>No items ordered yet.</li>");
                $orderTotal.text("");
                return;
            }

            let grandTotal = 0;

            keys.forEach(id => {
                const item = order[id];
                const total = item.quantity * item.price;
                grandTotal += total;

                // Render list item with +, –, Remove buttons
                $orderList.append(`
                        <li class="d-flex align-items-center mb-2" data-id="${id}">
                            <span class="flex-grow-1">${item.name} x ${item.quantity}</span>
                                <button class="btn btn-warning btn-sm me-2 summary-minus">–</button>
                                    <button class="btn btn-success btn-sm me-1 summary-plus">+</button>
                            <button class="btn btn-danger btn-sm summary-remove">Remove</button>
                        </li>
                    `);
            });
        }

        // Delegate clicks in the order summary
        $("#orderList")
            .on("click", ".summary-plus", function () {
                const id = $(this).closest("li").data("id");

                // update the order array
                order[id].quantity++;

                // push that change into the card’s input
                $(`#food${id}`).val(order[id].quantity);

                // redraw the summary
                refreshOrderList();
            })
            .on("click", ".summary-minus", function () {
                const id = $(this).closest("li").data("id");

                // decrement in our data, but never below 1
                order[id].quantity = Math.max(1, order[id].quantity - 1);

                // update the card
                $(`#food${id}`).val(order[id].quantity);

                // redraw the summary
                refreshOrderList();
            })
            .on("click", ".summary-remove", function () {
                const id = $(this).closest("li").data("id");

                // reset the card’s input to 0
                $(`#food${id}`).val(0);

                // delete it from our data
                delete order[id];

                // redraw summary
                refreshOrderList();
            });


        $("#toggleOrder").click(function () {
            const $summary = $("#orderSummary");
            const $button = $(this);

            $summary.slideToggle(200, function () {
                const isVisible = $summary.is(":visible");
                $button.text(isVisible ? "Hide Order Summary" : "Show Order Summary");
            });
        });
    });
    $("#submitOrderForm").on("submit", function (e) {
        console.log(order);
        const items = [];

        if (Object.keys(order).length === 0) {
            e.preventDefault();
            alert('Please order first.');
            return;
        }

        Object.keys(order).forEach(id => {
            items.push({
                MenuId: parseInt(id),
                Name: order[id].name,
                Price: order[id].price,
                Quantity: order[id].quantity
            });
        });

        $("#OrderItemsJson").val(JSON.stringify(items));
    });

</script>

