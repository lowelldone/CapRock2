@model Capstone2.Models.Order

@{
    ViewData["Title"] = "View Order";
    var chargedItems = ViewBag.ChargedItems as IEnumerable<dynamic>;
    bool isAdmin = ViewBag.IsAdmin ?? false;
    bool fromPast = ViewBag.FromPastOrders ?? false;
    bool hasPackageItems = Model?.OrderDetails?.Any(od => !string.IsNullOrEmpty(od.Type)) == true;
}

<style>
    .info-line {
        border-bottom: 1px solid black;
    }
</style>
<link rel="stylesheet" href="~/css/modern-ui.css" />

<div class="container-fluid modern-bg">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div class="modern-header">
            <div class="modern-header-icon">
                <i class="bi bi-receipt"></i>
            </div>
            <div>
                <h1 class="modern-title">Order Details</h1>
                <p class="modern-subtitle">View complete order information and details</p>
            </div>
        </div>
        <div class="modern-action-buttons">
            @if (Model.Customer.IsPaid && Model.Status == "Completed")
            {
                <button type="button" class="modern-action-btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#invoicePreviewModal">
                    <i class="bi bi-file-earmark-pdf me-1"></i> Generate Invoice
                </button>
            }
        </div>
    </div>

    <!-- Order Information Card -->
    <div class="modern-status-card">
        <div class="modern-status-card-header">
            <h5 class="modern-status-card-title">
                <i class="bi bi-info-circle"></i>
                Order Information
            </h5>
        </div>
        <div class="modern-card-body">
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Customer Name</label>
                        <div class="modern-name">@Model.Customer.Name</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Contact</label>
                        <div class="modern-info">@Model.Customer.ContactNo</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Address</label>
                        <div class="modern-address">@Model.Customer.Address</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Venue</label>
                        <div class="modern-info">@Model.Venue</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">No. Of Pax</label>
                        <div class="modern-info">@Model.NoOfPax</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label ">Order Date</label>
                        <div class="modern-info">@Model.OrderDate.ToShortDateString()</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Catering Date</label>
                        <div class="modern-info">@Model.CateringDate.ToShortDateString()</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Time of Food Serving</label>
                        <div class="modern-info">@Model.timeOfFoodServing.ToShortTimeString()</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Occasion</label>
                        <div class="modern-info">@Model.Occasion</div>
                    </div>
                    <div class="modern-form-group info-line">
                        <label class="modern-form-label">Motif</label>
                        <div class="modern-info">@Model.Motif</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (Model.OrderDetails?.Any() == true)
    {
        <!-- Ordered Items Card -->
        <div class="modern-status-card">
            <div class="modern-status-card-header">
                <h5 class="modern-status-card-title">
                    <i class="bi bi-list-ul"></i>
                    Ordered Items
                </h5>
            </div>
            <div class="table-responsive">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Menu</th>
                            @if (!hasPackageItems)
                            {
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            var freeLechonItems = Model.OrderDetails.Where(od => !string.IsNullOrEmpty(od.Type) && (od.Type == "Package Bonus" || od.IsFreeLechon == true)).ToList();
                            var regularItems = Model.OrderDetails.Where(od => !freeLechonItems.Contains(od)).ToList();
                        }

                        @foreach (var item in regularItems)
                        {
                            var isPackageItem = !string.IsNullOrEmpty(item.Type);
                            if (hasPackageItems)
                            {
                                <tr>
                                    <td>
                                        <div class="modern-name" style="word-wrap: break-word; white-space: normal;">
                                            @item.Menu.Name
                                        </div>
                                    </td>
                                </tr>
                            }
                            else
                            {
                                var unit = (decimal)(item.Menu?.Price ?? 0d);
                                var qty = item.Quantity;
                                var subtotal = unit * qty;
                                <tr>
                                    <td>
                                        <div class="modern-name" style="word-wrap: break-word; white-space: normal;">@item.Menu.Name</div>
                                    </td>
                                    <td>
                                        <div class="modern-info">@qty</div>
                                    </td>
                                    <td>
                                        <div class="modern-info">₱@unit.ToString("0.00")</div>
                                    </td>
                                    <td>
                                        <div class="modern-name">₱@subtotal.ToString("0.00")</div>
                                    </td>
                                </tr>
                            }
                        }

                        @* Display merged free lechons *@
                        @if (freeLechonItems.Any())
                        {
                            var lechonCount = freeLechonItems.Count;
                            <tr>
                                <td>
                                    <div class="modern-name" style="word-wrap: break-word; white-space: normal;">
                                        @if (lechonCount == 1)
                                        {
                                            <text>1 Whole Lechon (Package Bonus)</text>
                                        }
                                        else
                                        {
                                            <text>@lechonCount Whole Lechons (Package Bonus)</text>
                                        }
                                        <span class="badge bg-warning text-dark ms-1">Free</span>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Total Section -->
            <div class="modern-card-body">
                <div class="modern-form-group info-line">
                    <label class="modern-form-label">Total Payment</label>
                    <div class="modern-name fs-4">₱@(Model.TotalPayment.ToString("0.00"))</div>
                </div>

                @if (Model.IsRushOrder)
                {
                    <div class="modern-alert modern-alert-warning">
                        <i class="bi bi-lightning-fill me-2"></i>
                        <div>
                            <div class="fw-bold mb-1">Rush Order</div>
                            <div>Base Total: ₱@(((double)ViewBag.RushBaseTotal).ToString("N2"))</div>
                            <div>Rush Order Fee (10%): ₱@(((double)ViewBag.RushOrderFee).ToString("N2"))</div>
                            <div class="fw-semibold">Rush Total: ₱@(((double)ViewBag.RushBaseTotal + (double)ViewBag.RushOrderFee).ToString("N2"))</div>
                        </div>
                    </div>
                }

                @if (ViewBag.AdditionalCharges != null && (decimal)ViewBag.AdditionalCharges > 0)
                {
                    <div class="modern-alert modern-alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <div>
                            <div class="fw-bold">Total Additional Charges: ₱@(((decimal)ViewBag.AdditionalCharges).ToString("F2"))</div>
                            @if (chargedItems != null && chargedItems.Any())
                            {
                                <button type="button" class="modern-action-btn btn-outline-info mt-2" data-bs-toggle="modal" data-bs-target="#chargedItemsModal">
                                    View Charged Items
                                </button>
                            }
                        </div>
                    </div>
                }

                @if (Model.Status != "Pending")
                {
                    @if ((ViewBag.AdditionalCharges != null && (decimal)ViewBag.AdditionalCharges > 0) && !(isAdmin && Model.Status == "Ongoing"))
                    {
                        <div class="modern-form-group">
                            <label class="modern-form-label">Updated Total</label>
                            <div class="modern-name fs-4 text-primary">₱@(((decimal)ViewBag.EffectiveTotal).ToString("F2"))</div>
                        </div>
                    }
                    @if (Model.Status != "Completed")
                    {
                        <div class="modern-form-group">
                            <label class="modern-form-label">Remaining Balance</label>
                            <div class="modern-name @(ViewBag.RemainingBalance > 0 ? "text-warning" : "text-success")">
                                ₱@(((decimal)ViewBag.RemainingBalance).ToString("F2"))
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
    else
    {
        <div class="modern-status-card">
            <div class="modern-card-body text-center">
                <p class="text-muted"><em>No items in this order.</em></p>
            </div>
        </div>
    }

    @if (Model.Status == "Completed")
    {
        <!-- Assigned Staff Card -->
        <div class="modern-status-card">
            <div class="modern-status-card-header">
                <h5 class="modern-status-card-title">
                    <i class="bi bi-people"></i>
                    Assigned Staff
                </h5>
            </div>
            <div class="modern-card-body">
                @if (Model.HeadWaiter != null)
                {
                    <div class="modern-form-group">
                        <label class="modern-form-label">Head Waiter</label>
                        <div class="modern-info">
                            <i class="bi bi-person-badge me-1"></i>
                            @Model.HeadWaiter.User.FirstName @Model.HeadWaiter.User.LastName
                        </div>
                    </div>
                }

                @if (ViewBag.OrderWaiters != null && ((IEnumerable<dynamic>)ViewBag.OrderWaiters).Any())
                {
                    <div class="modern-form-group">
                        <label class="modern-form-label">Waiters</label>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var orderWaiter in (IEnumerable<dynamic>)ViewBag.OrderWaiters)
                                    {
                                        <tr>
                                            <td>
                                                <div class="modern-info">@orderWaiter.Waiter.User.FirstName @orderWaiter.Waiter.User.LastName</div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-center">
                        <p class="text-muted"><em>No waiters were assigned to this order.</em></p>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Action Buttons -->
    <div class="d-flex gap-3 mt-4">
        @if (Model.Status != "Completed" && Model.Status != "Ongoing" && Model.Status != "Accepted" && Model.Status != "Settling Balance")
        {
            <a asp-controller="Orders" asp-action="Edit" asp-route-id="@Model.OrderId" class="modern-action-btn btn-primary">
                <i class="bi bi-pencil-square me-2"></i>Edit Information
            </a>
            <a asp-controller="OrderDetails" asp-action="Edit" asp-route-orderId="@Model.OrderId" class="modern-action-btn btn-outline-warning">
                <i class="bi bi-list-ul me-2"></i>Edit Food Items
            </a>
        }

        @if (ViewBag.HasPayments == true)
        {
            <a asp-action="PaymentHistory" asp-route-id="@Model.Customer.CustomerID" asp-route-fromPastOrders="@(fromPast ? true : (bool?)null)" class="modern-action-btn btn-info">
                <i class="bi bi-clock-history me-2"></i>View Payment History
            </a>
        }

        @if (fromPast)
        {
            <a asp-action="PastOrders" class="modern-action-btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back
            </a>
        }
        else
        {
            <a asp-action="Index" class="modern-action-btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back
            </a>
        }
        @if (Model.Status != "Accepted" && Model.Status != "Ongoing" && Model.Status != "Completed" && Model.Status != "Settling Balance")
        {
            <a asp-action="PaymentDetails" asp-route-id="@Model.Customer.CustomerID" class="modern-action-btn btn-success ms-auto">
                <i class="bi bi-check-circle me-2"></i>Confirm Order
            </a>
        }
    </div>
</div>

@if (chargedItems != null && chargedItems.Any())
{
    <!-- Charged Items Modal -->
    <div class="modal fade" id="chargedItemsModal" tabindex="-1" aria-labelledby="chargedItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chargedItemsModalLabel">Items Charged (Lost/Damaged)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Lost</th>
                                    <th>Damaged</th>
                                    <th>Charge Per Item</th>
                                    <th>Total Charge</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in chargedItems)
                                {
                                    <tr>
                                        <td>
                                            <div class="modern-name">@item.MaterialName</div>
                                        </td>
                                        <td>
                                            <div class="modern-info">@item.Lost</div>
                                        </td>
                                        <td>
                                            <div class="modern-info">@item.Damaged</div>
                                        </td>
                                        <td>
                                            <div class="modern-info">₱@item.ChargePerItem</div>
                                        </td>
                                        <td>
                                            <div class="modern-name">₱@((item.Lost + item.Damaged) * item.ChargePerItem)</div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Invoice Preview Modal -->
@{
    var addCharges = ViewBag.AdditionalCharges != null ? (decimal)ViewBag.AdditionalCharges : 0m;
    var baseTotalDec = (decimal)Model.TotalPayment;
    var invoiceTotalDec = baseTotalDec + addCharges;
    var orderNo = !string.IsNullOrWhiteSpace(Model.OrderNumber)
        ? Model.OrderNumber
        : $"ORD-{Model.OrderDate:yyyyMMdd}-{Model.OrderId:D3}";
}

<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoicePreviewLabel">Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="invoicePrintSection" class="modern-status-card">
                    <div class="modern-card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <div class="modern-title">GRUSH Catering</div>
                                <div class="modern-subtitle">Official Invoice</div>
                            </div>
                            <div class="text-end">
                                <div><strong>Order No:</strong> @orderNo</div>
                                <div><strong>Order Date:</strong> @Model.OrderDate.ToString("dd/MM/yyyy")</div>
                                <div><strong>Catering Date:</strong> @Model.CateringDate.ToString("dd/MM/yyyy")</div>
                            </div>
                        </div>

                        <div class="modern-form-group">
                            <label class="modern-form-label">Billed To</label>
                            <div class="modern-name">@Model.Customer.Name</div>
                            <div class="modern-info">@Model.Customer.ContactNo</div>
                            <div class="modern-address">@Model.Customer.Address</div>
                        </div>

                        <div class="table-responsive mb-2">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Menu</th>
                                        @if (!hasPackageItems)
                                        {
                                            <th class="text-end">Quantity</th>
                                            <th class="text-end">Unit Price</th>
                                            <th class="text-end">Subtotal</th>
                                        }
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var invoiceFreeLechonItems = Model.OrderDetails.Where(od => !string.IsNullOrEmpty(od.Type) && (od.Type == "Package Bonus" || od.IsFreeLechon == true)).ToList();
                                        var invoiceRegularItems = Model.OrderDetails.Where(od => !invoiceFreeLechonItems.Contains(od)).ToList();
                                    }

                                    @foreach (var item in invoiceRegularItems)
                                    {
                                        var isPackageItem = !string.IsNullOrEmpty(item.Type);
                                        if (hasPackageItems)
                                        {
                                            <tr>
                                                <td>
                                                    <div class="modern-name" style="word-wrap: break-word; white-space: normal;">
                                                        @item.Menu.Name
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                        else
                                        {
                                            var unit = (double)(item.Menu?.Price ?? 0d);
                                            var qty = item.Quantity;
                                            var sub = unit * qty;
                                            <tr>
                                                <td>
                                                    <div class="modern-name" style="word-wrap: break-word; white-space: normal;">@item.Menu.Name</div>
                                                </td>
                                                <td class="text-end">
                                                    <div class="modern-info">@qty</div>
                                                </td>
                                                <td class="text-end">
                                                    <div class="modern-info">₱@unit.ToString("N2")</div>
                                                </td>
                                                <td class="text-end">
                                                    <div class="modern-name">₱@sub.ToString("N2")</div>
                                                </td>
                                            </tr>
                                        }
                                    }

                                    @* Display merged free lechons in invoice *@
                                    @if (invoiceFreeLechonItems.Any())
                                    {
                                        var invoiceLechonCount = invoiceFreeLechonItems.Count;
                                        <tr>
                                            <td>
                                                <div class="modern-name" style="word-wrap: break-word; white-space: normal;">
                                                    @if (invoiceLechonCount == 1)
                                                    {
                                                        <text>1 Whole Lechon (Package Bonus)</text>
                                                    }
                                                    else
                                                    {
                                                        <text>@invoiceLechonCount Whole Lechons (Package Bonus)</text>
                                                    }
                                                    <span class="badge bg-warning text-dark ms-1">Free</span>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex flex-column align-items-end">
                            <div><span class="fw-bold">Base Total:</span> ₱@baseTotalDec.ToString("N2")</div>
                            @if (addCharges > 0)
                            {
                                <div class="text-danger"><span class="fw-bold">Additional Charges:</span> ₱@addCharges.ToString("N2")</div>
                            }
                            <div class="fs-5"><span class="fw-bold">Invoice Total:</span> ₱@invoiceTotalDec.ToString("N2")</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a asp-controller="Customers" asp-action="GenerateInvoice" asp-route-id="@Model.Customer.CustomerID" class="modern-action-btn btn-primary">
                    <i class="bi bi-download me-1"></i> Download PDF
                </a>
                <button type="button" class="modern-action-btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var shouldShow = '@(ViewBag.ShowInvoiceModal == true ? "true" : "false")' === 'true';
        if (shouldShow) {
            var modalEl = document.getElementById('invoicePreviewModal');
            if (modalEl) {
                var modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
        }
    });
</script>
