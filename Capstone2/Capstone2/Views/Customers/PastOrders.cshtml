@model IEnumerable<Capstone2.Models.Order>

@{
	ViewData["Title"] = "Past Orders";
	var addDict = ViewBag.AdditionalChargesByOrder as System.Collections.Generic.IDictionary<int, double>;
	var effDict = ViewBag.EffectiveTotalByOrder as System.Collections.Generic.IDictionary<int, double>;
	var payDict = ViewBag.PaymentsTotalByOrder as System.Collections.Generic.IDictionary<int, double>;
	var remDict = ViewBag.RemainingBalanceByOrder as System.Collections.Generic.IDictionary<int, double>;
	string searchString = ViewBag.SearchString as string ?? string.Empty;
	DateTime? startDate = ViewBag.StartDate as DateTime?;
	DateTime? endDate = ViewBag.EndDate as DateTime?;
}

<link rel="stylesheet" href="~/css/modern-ui.css" />

<div class="container-fluid modern-bg">
	<!-- Header Section -->
	<div class="d-flex justify-content-between align-items-start mb-4">
		<div class="modern-header">
			<div class="modern-header-icon">
				<i class="bi bi-clock-history"></i>
			</div>
			<div>
				<h1 class="modern-title">Completed Orders</h1>
				<p class="modern-subtitle">View and manage completed catering orders from previous dates</p>
			</div>
		</div>
		<div class="modern-action-buttons">
			<a asp-action="Index" class="btn btn-outline-primary">
				<i class="bi bi-arrow-left"></i>
				Back
			</a>
		</div>
	</div>

	<!-- Search Section -->
	<div class="modern-search-card">
		<form asp-action="PastOrders" method="get" class="modern-search-form past-orders-form">
			<div>
				<label class="modern-form-label">Search Orders</label>
				<input type="text" name="searchString" class="modern-form-control" placeholder="Search by Order No., Customer, Venue..." value="@searchString" />
			</div>
			<div>
				<label class="modern-form-label">Start Date</label>
				<input type="date" name="startDate" class="modern-form-control" value="@(startDate.HasValue ? startDate.Value.ToString("yyyy-MM-dd") : string.Empty)" />
			</div>
			<div>
				<label class="modern-form-label">End Date</label>
				<input type="date" name="endDate" class="modern-form-control" value="@(endDate.HasValue ? endDate.Value.ToString("yyyy-MM-dd") : string.Empty)" />
			</div>
			<div>
				<button type="submit" class="modern-btn-search w-100">
					<i class="bi bi-search me-2"></i>Search
				</button>
			</div>
			<div>
				<a asp-action="PastOrders" class="modern-action-btn btn-outline-secondary w-100">
					<i class="bi bi-arrow-clockwise me-2"></i>Clear
				</a>
			</div>
		</form>
	</div>

	<!-- Past Orders Table -->
	<div class="modern-status-card">
		<div class="modern-status-card-header">
			<h5 class="modern-status-card-title">
				<i class="bi bi-clock-history"></i>
				Past Orders (@Model.Count())
			</h5>
		</div>
		<div class="table-responsive">
			<table class="modern-table table-hover align-middle mb-0">
				<thead>
					<tr>
						<th>Order No.</th>
						<th>Customer</th>
						<th>Catering Date</th>
						<th>Venue</th>
						<th class="text-end">Base Total</th>
						<th class="text-end">Additional</th>
						<th class="text-end">Invoice Total</th>
						<th class="text-end">Actions</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var o in Model)
					{
						var add = addDict != null && addDict.ContainsKey(o.OrderId) ? addDict[o.OrderId] : 0d;
						var invoiceTotal = effDict != null && effDict.ContainsKey(o.OrderId) ? effDict[o.OrderId] : o.TotalPayment + add;
						var payments = payDict != null && payDict.ContainsKey(o.OrderId) ? payDict[o.OrderId] : 0d;
						var remaining = remDict != null && remDict.ContainsKey(o.OrderId) ? remDict[o.OrderId] : 0d;
						var displayRemaining = o.Status == "Completed" ? 0d : remaining;
						<tr>
							<td>
								@if (!string.IsNullOrWhiteSpace(o.OrderNumber))
								{
									<span class="modern-badge">@o.OrderNumber</span>
								}
								else
								{
									<span class="text-muted">-</span>
								}
							</td>
							<td>
								<div class="modern-name">@o.Customer?.Name</div>
							</td>
							<td>
								<div class="modern-info">@o.CateringDate.ToString("yyyy-MM-dd")</div>
							</td>
							<td>
								<div class="modern-info">@o.Venue</div>
							</td>
							<td class="text-end">
								<div class="modern-name">₱@o.TotalPayment.ToString("N2")</div>
							</td>
							<td class="text-end">
								<div class="modern-info">₱@add.ToString("N2")</div>
							</td>
							<td class="text-end">
								<div class="modern-name">₱@invoiceTotal.ToString("N2")</div>
							</td>
							<td class="text-end">
								<div class="modern-table-actions">
									<a asp-action="ViewOrder" asp-route-id="@o.CustomerID" asp-route-fromPastOrders="true" class="modern-table-action-btn btn-outline-secondary">
										<i class="bi bi-eye"></i>
										View
									</a>
									<a asp-action="InventoryReport" asp-route-id="@o.CustomerID" asp-route-fromPastOrders="true" class="modern-table-action-btn btn-outline-info">
										<i class="bi bi-clipboard-data"></i>
										Inventory
									</a>
									@*<form asp-action="Delete" asp-route-id="@o.CustomerID" method="post" style="display: inline;">
										<input type="hidden" name="fromPastOrders" value="true" />
										<button type="submit" class="modern-table-action-btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete this order? This action cannot be undone.')">
											<i class="bi bi-trash"></i>
											Delete
										</button>
									</form>*@
								</div>
							</td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>
</div>


